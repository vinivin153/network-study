연결을 끊는쪽은 애플리케이션에 따라 클라이언트측이 될 수도 있고 서버측이 될 수도 있다

서버측에서 연결끊기를 먼저 하는것을 기준으로 설명

### 데이터 보내기를 완료했을 때 연결 끊기

[서버]

1. 서버측 어플리케이션이 Socket 라이브러리의 close를 호출
2. 서버측 프로토콜 스택이 TCP헤더를 만들고 컨트롤 비트의 FIN 비트를 1로 설정
3. IP담당 부분에 의뢰해 클라이언트에 송신과 동시에 서버측 소켓에 연결 끊기 동작에 들어갔다는 정보를 기록

[클라이언트]

1. FIN에 1을 설정한 TCP헤더가 도착과 동시에 클라이언트 소켓에 연결 끊기 동작에 들어갔다는 것을 기록
2. 패킷을 받았다고 알리기 위해 ACK를 서버측으로 전송
3. 애플리케이션이 데이터를 read를 호출해 데이터를 가지러 올 때 까지 대기
4. 가지러 온 경우 데이터를 넘기지 않고 서버에서 보낸 데이터를 전부 수신완료 했다는 사실을 애플리케이션에 알림
5. 클라이언트 애플리케이션도 close를 호출해 데이터 송수신 동작을 끝냄
6. FIN 비트에 1을 설정한 TCP 헤더를 만들고 서버에 송신
7. 서버에서 ACK가 돌아오면 종료

### 소켓을 말소

- 연결을 끊고 나서 사용하지 않는 소켓을 말소하는데 즉시 말소시키지 않고 잠시 기다린 후 말소시킨다
  - 예상치 못한 오류 방지
    - ex> FIN을 보냈을 때 ACK가 돌아오지 않는 경우 재전송해야 한다

### 정리

1. 소켓 작성
   1. 패킷을 주고 받지 않음
2. 접속동작
   1. SYN과 ACK를 주고 받음
3. 송수신동작
   1. request메시지를 적당한 크기로 나누고 TCP헤더를 붙여 전송
   2. 수신버퍼의 윈도우값도 전송
4. 연결끊기 동작
   1. 1로 설정한 FIN값과 ACK를 주고 받음
